(function(e,t,n,r){function c(t,r){this.w=e(n);this.el=e(t);this.options=e.extend({},l,r);this.init()}var i="ontouchstart"in n;var s=function(){var e=n.createElement("div"),r=n.documentElement;if(!("pointerEvents"in e.style)){return false}e.style.pointerEvents="auto";e.style.pointerEvents="x";r.appendChild(e);var i=t.getComputedStyle&&t.getComputedStyle(e,"").pointerEvents==="auto";r.removeChild(e);return!!i}();var o=i?"touchstart":"mousedown",u=i?"touchmove":"mousemove",a=i?"touchend":"mouseup",f=i?"touchcancel":"mouseup";var l={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",noChildrenClass:"dd-nochildren",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,startDelayMsec:0,beforeStartCallback:null,expandIfNeededCallback:null,reject:[],dropCallback:null,cloneNodeOnDrag:false,dragOutsideToDelete:false,expandCallback:null,collapseCallback:null};c.prototype={init:function(){var n=this;n.reset();n.el.data("nestable-group",this.options.group);n.placeEl=e('<div class="'+n.options.placeClass+'"/>');e.each(this.el.find(n.options.itemNodeName),function(t,r){n.setParent(e(r))});n.el.on("click","button",function(t){if(n.dragEl||!i&&t.button!==0){return}var r=e(t.currentTarget),s=r.data("action"),o=r.parent(n.options.itemNodeName);if(s==="collapse"){n.collapseItem(o)}if(s==="expand"){n.expandItem(o)}});var r={init:function(e,t){this.cleanup();if(e.ctrlKey)return;this.startTouch=t;this.timeout=setTimeout(function(){e.preventDefault();n.dragStart(t)},n.options.startDelayMsec)},isBigMove:function(e){return this.startTouch&&Math.abs(this.startTouch.pageX-e.pageX)+Math.abs(this.startTouch.pageY-e.pageY)>40},cleanup:function(){this.startTouch=null;clearTimeout(this.timeout)}};var s=function(t){var s=e(t.target);if(n.options.reject.length>0){n.nestableCopy=s.closest("."+n.options.rootClass).clone(true)}if(!s.hasClass(n.options.handleClass)){if(s.closest("."+n.options.noDragClass).length){return}s=s.closest("."+n.options.handleClass)}if(!s.length||n.dragEl||!i&&t.which!==1||i&&t.touches.length!==1){return}if(typeof n.options.beforeStartCallback==="function"){if(false===n.options.beforeStartCallback.call(n,t))return}var o=i?t.touches[0]:t;if(n.options.startDelayMsec){r.init(t,o)}else{t.preventDefault();n.dragStart(o)}};var l=function(e){var t=i?e.touches[0]:e;if(n.dragEl){e.preventDefault();n.dragMove(t)}else{if(r.isBigMove(t)){r.cleanup()}}};var c=function(e){if(n.dragEl){e.preventDefault();n.dragStop(i?e.touches[0]:e)}r.cleanup()};if(i){n.el[0].addEventListener(o,s,false);t.addEventListener(u,l,false);t.addEventListener(a,c,false);t.addEventListener(f,c,false)}else{n.el.on(o,s);n.w.on(u,l);n.w.on(a,c)}var h=function(){r.cleanup();if(i){n.el[0].removeEventListener(o,s,false);t.removeEventListener(u,l,false);t.removeEventListener(a,c,false);t.removeEventListener(f,c,false)}else{n.el.off(o,s);n.w.off(u,l);n.w.off(a,c)}n.el.off("click");n.el.unbind("destroy-nestable");n.el.data("nestable",null);var h=n.el[0].getElementsByTagName("button");e(h).remove()};n.el.bind("destroy-nestable",h)},destroy:function(){this.expandAll();this.el.trigger("destroy-nestable")},serialize:function(){var t,n=0,r=this,i=function(t,n){var s=[],o=t.children(r.options.itemNodeName);o.each(function(){var t=e(this),o=e.extend({},t.data()),u=t.children(r.options.listNodeName);if(u.length){o.children=i(u,n+1)}s.push(o)});return s};t=i(r.el.find(r.options.listNodeName).first(),n);return t},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.dragItem=null;this.hasNewRoot=false;this.pointEl=null;this.sourceRoot=null;this.isOutsideRoot=false},expandItem:function(t){t.removeClass(this.options.collapsedClass);t.children('[data-action="expand"]').hide();t.children('[data-action="collapse"]').show();t.children(this.options.listNodeName).show();this.el.trigger("expand",[t]);t.trigger("expand");if(e.isFunction(this.options.expandCallback)){var n={sourceEl:t,sourceId:t.data("id")};this.options.expandCallback.call(this,n)}},collapseItem:function(t){var n=t.children(this.options.listNodeName);if(n.length){t.addClass(this.options.collapsedClass);t.children('[data-action="collapse"]').hide();t.children('[data-action="expand"]').show();t.children(this.options.listNodeName).hide()}this.el.trigger("collapse",[t]);t.trigger("collapse");if(e.isFunction(this.options.collapseCallback)){var r={sourceEl:t,sourceId:t.data("id")};this.options.collapseCallback.call(this,r)}},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))})},setParent:function(t){if(t.children(this.options.listNodeName).length){t.prepend(e(this.options.expandBtnHTML));t.prepend(e(this.options.collapseBtnHTML))}if((" "+t[0].className+" ").indexOf(" "+l.collapsedClass+" ")>-1){t.children('[data-action="collapse"]').hide()}else{t.children('[data-action="expand"]').hide()}},unsetParent:function(e){e.removeClass(this.options.collapsedClass);e.children("[data-action]").remove();e.children(this.options.listNodeName).remove()},dragStart:function(t){var i=this.mouse,s=e(t.target),o=s.closest("."+this.options.handleClass).closest(this.options.itemNodeName);if(o.length!=1||!o[0].parentNode){return}this.sourceRoot=s.closest("."+this.options.rootClass);this.dragItem=o;this.placeEl.css("height",o.height());i.offsetX=t.offsetX!==r?t.offsetX:t.pageX-s.offset().left;i.offsetY=t.offsetY!==r?t.offsetY:t.pageY-s.offset().top;i.startX=i.lastX=t.pageX;i.startY=i.lastY=t.pageY;this.dragRootEl=this.el;this.dragEl=e(n.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",o.width());if(this.options.cloneNodeOnDrag){o.after(o.clone())}else{o.after(this.placeEl)}o[0].parentNode.removeChild(o[0]);o.appendTo(this.dragEl);e(n.body).append(this.dragEl);this.dragEl.css({left:t.pageX-i.offsetX,top:t.pageY-i.offsetY});var u,a,f=this.dragEl.find(this.options.itemNodeName);for(u=0;u<f.length;u++){a=e(f[u]).parents(this.options.listNodeName).length;if(a>this.dragDepth){this.dragDepth=a}}},dragStop:function(t){var n=this.dragEl.children(this.options.itemNodeName).first();if(n[0]&&n[0].parentNode){n[0].parentNode.removeChild(n[0])}if(this.isOutsideRoot&&this.options.dragOutsideToDelete){var r=this.placeEl.parent();this.placeEl.remove();if(!r.children().length){this.unsetParent(r.parent())}if(!this.dragRootEl.find(this.options.itemNodeName).length){this.dragRootEl.append('<div class="'+this.options.emptyClass+'"/>')}}else{this.placeEl.replaceWith(n)}if(!this.moving){e(this.dragItem).trigger("click")}var i;var s=false;for(i=0;i<this.options.reject.length;i++){var o=this.options.reject[i];if(o.rule.apply(this.dragRootEl)){var u=n.clone(true);this.dragRootEl.html(this.nestableCopy.children().clone(true));if(o.action){o.action.apply(this.dragRootEl,[u])}s=true;break}}if(!s){this.dragEl.remove();this.el.trigger("change");var a=n.parent().parent();var f=null;if(a!==null&&!a.is("."+this.options.rootClass)){f=a.data("id")}if(e.isFunction(this.options.dropCallback)){var l={sourceId:n.data("id"),destId:f,sourceEl:n,destParent:a,destRoot:n.closest("."+this.options.rootClass),sourceRoot:this.sourceRoot,moving:this.moving};this.options.dropCallback.call(this,l)}if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()}},dragMove:function(r){var i,o,u,a,f,l=this.options,c=this.mouse;this.dragEl.css({left:r.pageX-c.offsetX,top:r.pageY-c.offsetY});c.lastX=c.nowX;c.lastY=c.nowY;c.nowX=r.pageX;c.nowY=r.pageY;c.distX=c.nowX-c.lastX;c.distY=c.nowY-c.lastY;c.lastDirX=c.dirX;c.lastDirY=c.dirY;c.dirX=c.distX===0?0:c.distX>0?1:-1;c.dirY=c.distY===0?0:c.distY>0?1:-1;var h=Math.abs(c.distX)-Math.abs(c.distY);var p=h>0?1:0;if(!this.moving){c.dirAx=p;this.moving=true;return}if(c.dirAx!==p&&Math.abs(h)>5){c.distAxX=0;c.distAxY=0}else{c.distAxX+=Math.abs(c.distX);if(c.dirX!==0&&c.dirX!==c.lastDirX){c.distAxX=0}c.distAxY+=Math.abs(c.distY);if(c.dirY!==0&&c.dirY!==c.lastDirY){c.distAxY=0}}c.dirAx=p;if(c.dirAx&&c.distAxX>=l.threshold){c.distAxX=0;u=this.placeEl.prev(l.itemNodeName);if(c.distX>0&&u.length&&this.options.expandIfNeededCallback){this.options.expandIfNeededCallback(u)}if(c.distX>0&&u.length&&!u.hasClass(l.collapsedClass)&&!u.hasClass(l.noChildrenClass)){i=u.children(l.listNodeName).last();f=this.placeEl.parents(l.listNodeName).length;if(f+this.dragDepth<=l.maxDepth){if(!i.length){i=e("<"+l.listNodeName+"/>").addClass(l.listClass);i.append(this.placeEl);u.append(i);this.setParent(u)}else{i=u.children(l.listNodeName).last();i.append(this.placeEl)}}}if(c.distX<0){a=this.placeEl.next(l.itemNodeName);if(!a.length){o=this.placeEl.parent();this.placeEl.closest(l.itemNodeName).after(this.placeEl);if(!o.children().length){this.unsetParent(o.parent())}}}}var d=false;if(!s){this.dragEl[0].style.visibility="hidden"}this.pointEl=e(n.elementFromPoint(r.pageX-n.documentElement.scrollLeft,r.pageY-(t.pageYOffset||n.documentElement.scrollTop)));if(this.dragRootEl.has(this.pointEl).length){this.isOutsideRoot=false;this.dragEl[0].style.opacity=1}else{this.isOutsideRoot=true;this.dragEl[0].style.opacity=.5}var v=this.pointEl.closest("."+l.rootClass),m=this.dragRootEl.data("nestable-id")!==v.data("nestable-id");this.isOutsideRoot=!v.length;if(!s){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(l.handleClass)){this.pointEl=this.pointEl.closest(l.itemNodeName)}if(this.pointEl.hasClass(l.emptyClass)){d=true}else if(!this.pointEl.length||!this.pointEl.hasClass(l.itemClass)){return}if(!c.dirAx||m||d){if(m&&l.group!==v.data("nestable-group")){return}f=this.dragDepth-1+this.pointEl.parents(l.listNodeName).length;if(f>l.maxDepth){return}var g=r.pageY<this.pointEl.offset().top+this.pointEl.height()/2;o=this.placeEl.parent();if(d){i=e(n.createElement(l.listNodeName)).addClass(l.listClass);i.append(this.placeEl);this.pointEl.replaceWith(i)}else if(g){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}if(!o.children().length){this.unsetParent(o.parent())}if(!this.dragRootEl.find(l.itemNodeName).length){this.dragRootEl.append('<div class="'+l.emptyClass+'"/>')}this.dragRootEl=v;if(m){this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};e.fn.nestable=function(t){var n=this,r=this;var i=function(e){function n(){return((1+Math.random())*65536||0).toString(16).substring(1)}var t=e||"-";return n()+n()+t+n()+t+n()+t+n()+t+n()+n()+n()};n.each(function(){var n=e(this).data("nestable");if(!n){e(this).data("nestable",new c(this,t));e(this).data("nestable-id",i())}else{if(typeof t==="string"&&typeof n[t]==="function"){r=n[t]()}}});return r||n}})(window.jQuery||window.Zepto,window,document)